# x402 Protocol Research

## Overview
x402 is Coinbase's HTTP payment protocol — HTTP 402 "Payment Required" as a machine-native payment layer. It lets any HTTP endpoint require and receive payment before serving a response.

## NPM Packages (as of Feb 2026)
- `@x402/core` v2.4.0 — Core types, client, facilitator abstractions
- `@x402/fetch` v2.4.0 — Fetch wrapper (client-side payment automation)
- `@x402/evm` v2.4.0 — EVM implementation (EIP-3009 USDC, Permit2)
- `@x402/svm` — Solana implementation
- Latest published 3 days ago by Coinbase (actively maintained)

## Protocol Flow

### Client Side (paying agent):
1. Agent makes a normal HTTP request to a paid endpoint
2. Server returns HTTP 402 with `X-PAYMENT-REQUIRED` header containing PaymentRequirements JSON
3. `wrapFetchWithPayment()` catches the 402, reads requirements
4. Signs EIP-3009 `transferWithAuthorization` (no on-chain gas needed for signing)
5. Retries request with `X-PAYMENT` header containing signed payment payload
6. Server verifies signature, settles on-chain (or off-chain via facilitator), returns 200

### PaymentRequirements structure:
```typescript
{
  scheme: "exact",       // payment scheme
  network: "eip155:8453", // CAIP-2 chain ID
  maxAmountRequired: "500000", // in token base units (0.50 USDC = 500000)
  resource: "https://api.example.com/endpoint",
  description: "AI audit service",
  mimeType: "application/json",
  payTo: "0x...",         // payment recipient address
  maxTimeoutSeconds: 300,
  asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // USDC on Base
  outputSchema: null,
  extra: {}
}
```

## Two Payment Methods
1. **EIP-3009** (recommended for USDC): `transferWithAuthorization` — gasless for payer, gas paid by facilitator/server
2. **Permit2** (universal fallback): Works for any ERC-20 via Uniswap's Permit2 contract

## Key Addresses (Base mainnet)
- USDC: `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`
- PERMIT2: `0x000000000022D473030F116dDEE9F6B43aC78BA3`
- x402ExactPermit2Proxy: `0x4020615294c913F045dc10f0a5cdEbd86c280001`

## Client API
```typescript
// Simple - recommended
import { wrapFetchWithPaymentFromConfig } from "@x402/fetch";
import { ExactEvmScheme } from "@x402/evm";
import { privateKeyToAccount } from "viem/accounts";

const fetchWithPayment = wrapFetchWithPaymentFromConfig(fetch, {
  schemes: [{ network: "eip155:*", client: new ExactEvmScheme(account) }]
});

// Builder pattern
const client = new x402Client()
  .register("eip155:*", new ExactEvmScheme(signer));
const fetchWithPayment = wrapFetchWithPayment(fetch, client);
```

## Server Side (receiving payment)
- `ExactEvmServer` builds payment requirements
- `ExactEvmFacilitator` verifies and settles on-chain
- `decodePaymentResponseHeader()` extracts payment details from response

## Protocol Versions
- v2 (current): CAIP-2 network IDs, wildcard support, partial payload
- v1 (legacy): Simple network names (base, base-sepolia, etc.)

## Integration with Identity
- ERC-8004 spec explicitly mentions x402: `"x402Support": true/false` in registration file
- Feedback can include x402 payment receipts as proof of value exchange
- No existing lib does this automatically — this is SDK's value add

## What We've Used
- `@x402/fetch` + `@x402/evm` for Watchy audit (paid 0.50 USDC)
- Used `wrapFetchWithPayment` + manual `x402Client` + `ExactEvmScheme`
- Payment was automatic once configured — worked seamlessly
